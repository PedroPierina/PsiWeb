<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8">
        <title>PsiWeb</title>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
        <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
  		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  		<link href="/css/chatStyle.css" rel="stylesheet" />
    </head>

    <body>
    
    	<nav class="navbar navbar-expand-lg navbar-light bg-dark">
		  <a class="navbar-brand" href="/feed">PsiWeb</a>
		  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
		    <span class="navbar-toggler-icon"></span>
		  </button>
		
		  <div class="collapse navbar-collapse" id="navbarSupportedContent">
		    <ul class="navbar-nav mr-auto">
		      <li class="nav-item active">
		        <a class="nav-link" href="/profile">Perfil <span class="sr-only">(current)</span></a>
		      </li>
		      <li class="nav-item">
		        <a class="nav-link" href="/chat">Chat</a>
		      </li>
		      <li class="nav-item dropdown">
		        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		          Conta
		        </a>
		        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
		          <a class="dropdown-item" href="/logout">Logout</a>
		          <div class="dropdown-divider"></div>
		          <a class="dropdown-item" href="/deleteUser">Deletar Conta</a>
		        </div>
		      </li>
		      
		    </ul>
		    
		    <form class="form-inline my-2 my-lg-0" method="post" id="search" th:action="@{/search}">
		      <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" id="search" name="search">
		      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
		    </form>
		    
		  </div>
		</nav>
		<!----------------------------------------------------BootStrap------------------------------------------------------>
    
    <div class="container-fluid h-100">
			<div class="row justify-content-center h-100">
				<div class="col-md-4 col-xl-3 chat"><div class="card mb-sm-3 mb-md-0 contacts_card">
					<div class="card-header">
						<div class="input-group">
							<input type="text" placeholder="Search..." name="" class="form-control search">
							<div class="input-group-prepend">
								<span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
							</div>
						</div>
					</div>
					<div class="card-body contacts_body">
						<ul class="contacts">
							<li class="active" th:each="friend : ${friends}" th:onclick="'javascript:callChat(\'' + ${friend.friendId} + '\', \'' + ${friend.type} + '\');'" id="friend" >
								<div class="d-flex bd-highlight">
									<div class="img_cont">
										<img th:src="|data:image/png;base64,${friend.profilePicture}|" class="rounded-circle user_img" th:onclick="'javascript:callChat(\'' + ${friend.friendId} + '\', \'' + ${friend.type} + '\');'">
										<span class="online_icon"></span>
									</div>
									<div class="user_info">
										<span ><h5 th:text="${friend.name}" ></h5></span>
										<p></p>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="card-footer"></div>
				</div></div>
				<div class="col-md-7 col-xl-4 chat">
					<div class="card2">
						<div class ="sticky">
							<div class="card-header msg_head">
								<div class="d-flex bd-highlight">
									<div class="img_cont">
										<img th:src="|data:image/png;base64,${chatFriend.profilePicture}|" class="rounded-circle user_img" th:onclick="'javascript:callChat(\'' + ${chatFriend.friendId} + '\', \'' + ${chatFriend.type} + '\');'">
										<span class="online_icon"></span>
									</div>
									<div class="user_info">
										<span>[[${chatFriend.name}]]</span>
									</div>
								</div>
							</div>
						</div>
						
						<div class="card-body msg_card_body" >
							<div id="chatBox">
								
							</div>
							<div class ="sticky2">
								<div class="footer">
									<div class="card-footer">
										<form class="input-group" th:action="@{/chat}" method="post">
												<input type = "text" name="body" class="form-control type_msg" placeholder="Type your message..."/>
												<input type="hidden" id="friendId" name="friendId" th:value="${chatFriend.friendId}">
												<input type="hidden" id="friendId" name="friendType" th:value="${chatFriend.type}">
												<button type="submit" class="input-group-text send_btn">
												    <i class="fas fa-paper-plane"></i>
												</button>										
											</form>
									</div>
								</div>
							</div>
						</div>
						
					<!--  -->	
					</div>
				</div>
			</div>
     <script th:inline="javascript" >
		function callChat(id, type){
			window.location.href='/chat/requestInvidualChat/' + id + '/' + type;
		};
		
		window.onload = () => {
			const messages = [[${messages}]];
			const chatBox = document.getElementById("chatBox");
			const user = [[${user}]];
			const chatFriendPic = [[${chatFriend.profilePicture}]];
       	 	
			
       	 	for(var i = 0; i < messages.length; i++){
				if(messages[i].fromEmail == [[${user.userEmail}]]){
					chatBox.innerHTML += `
						<div class="fix">
							<div class="d-flex justify-content-end mb-4">
								<div class="msg_cotainer_send">
									${messages[i].body}
								</div>
									<span class="msg_time_send">${messages[i].createDate}</span>
								<div class="img_cont_msg">
									<img src="data:image/png;base64,${user.profilePicture}" class="rounded-circle user_img">
								</div>
							</div>
						</div>`;
				}else{
					chatBox.innerHTML += `
						<div class="d-flex justify-content-start mb-4">
							<div class="msg_cotainer_send">
								${messages[i].body}
								
							</div>
							<div class="img_cont_msg">
								<img src="data:image/png;base64,${chatFriendPic}" class="rounded-circle user_img">	
							</div>
						</div>`;
				}  	 		
       	 	}
       	 
       	 
    	};
	</script>
    
    </body>
    
    
</html>
